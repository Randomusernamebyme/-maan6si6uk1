"use strict";(()=>{var e={};e.id=570,e.ids=[570],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},3263:e=>{e.exports=import("firebase-admin/app")},79637:e=>{e.exports=import("firebase-admin/auth")},72929:e=>{e.exports=import("firebase-admin/firestore")},19655:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>u,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>E,staticGenerationAsyncStorage:()=>p});var i=r(49303),a=r(88716),s=r(60670),o=r(21161),c=e([o]);o=(c.then?(await c)():c)[0];let l=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/logs/route",pathname:"/api/admin/logs",filename:"route",bundlePath:"app/api/admin/logs/route"},resolvedPagePath:"C:\\Users\\annie\\OneDrive\\Desktop\\maan6si6uk1\\app\\api\\admin\\logs\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:E}=l,A="/api/admin/logs/route";function u(){return(0,s.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:p})}n()}catch(e){n(e)}})},21161:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{GET:()=>c,POST:()=>u});var i=r(87070),a=r(52099),s=e([a]);async function o(e){let t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return null;let r=t.split("Bearer ")[1];try{let e=(0,a.Dh)(),t=await e.verifyIdToken(r),n=(0,a._B)(),i=await n.collection("users").doc(t.uid).get();if(!i.exists||i.data()?.role!=="admin")return null;return t}catch(e){return null}}async function c(e){try{if(!await o(e))return i.NextResponse.json({error:"未授權，需要管理員權限"},{status:401});let{searchParams:t}=new URL(e.url),r=(0,a._B)().collection("activity_logs").orderBy("createdAt","desc"),n=t.get("userId"),s=t.get("action"),c=t.get("startDate"),u=t.get("endDate");n&&(r=r.where("userId","==",n)),s&&(r=r.where("action","==",s));let l=(await r.get()).docs.map(e=>({id:e.id,...e.data(),createdAt:e.data().createdAt?.toDate()})),d=l;return(c||u)&&(d=l.filter(e=>{let t=e.createdAt;return!(!t||c&&t<new Date(c)||u&&t>new Date(u))})),i.NextResponse.json({logs:d})}catch(e){return console.error("Error fetching logs:",e),i.NextResponse.json({error:e.message||"獲取操作日誌失敗"},{status:500})}}async function u(e){try{let t=await o(e);if(!t)return i.NextResponse.json({error:"未授權，需要管理員權限"},{status:401});let{action:r,targetType:n,targetId:s,description:c,changes:u}=await e.json();if(!r||!n||!s||!c)return i.NextResponse.json({error:"缺少必要欄位"},{status:400});let l=(0,a._B)(),d={userId:t.uid,action:r,targetType:n,targetId:s,description:c,changes:u};return await l.collection("activity_logs").add({...d,createdAt:new Date}),i.NextResponse.json({success:!0})}catch(e){return console.error("Error creating log:",e),i.NextResponse.json({error:e.message||"創建操作日誌失敗"},{status:500})}}a=(s.then?(await s)():s)[0],n()}catch(e){n(e)}})},52099:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.d(t,{Dh:()=>d,_B:()=>p});var i=r(3263),a=r(79637),s=r(72929),o=r(55315),c=r(92048),u=e([i,a,s]);[i,a,s]=u.then?(await u)():u;let E=null,A=null,m=null;function l(){if(E&&A&&m)return{adminApp:E,adminAuth:A,adminDb:m};if((0,i.getApps)().length>0){let e=(0,i.getApps)()[0];return E=e,A=(0,a.getAuth)(e),m=(0,s.getFirestore)(e),{adminApp:E,adminAuth:A,adminDb:m}}if("1"!==process.env.VERCEL){let e=(0,o.join)(process.cwd(),"maan6si6uk1-firebase-adminsdk-fbsvc-76e70ff62f.json");if((0,c.existsSync)(e))try{let t=JSON.parse((0,c.readFileSync)(e,"utf8"));return E=(0,i.initializeApp)({credential:(0,i.cert)(t)}),A=(0,a.getAuth)(E),m=(0,s.getFirestore)(E),{adminApp:E,adminAuth:A,adminDb:m}}catch(e){console.warn("無法讀取 JSON 文件，嘗試使用環境變數:",e)}}let e=process.env.FIREBASE_ADMIN_PRIVATE_KEY;if(!e)throw Error("Firebase Admin SDK 配置不完整：缺少 FIREBASE_ADMIN_PRIVATE_KEY");let t=e.trim();if(!(t=(t=(t=(t=(t=(t=t.replace(/^["']|["']$/g,"")).replace(/\\\\n/g,"\n")).replace(/\\n/g,"\n")).replace(/\r\n/g,"\n")).replace(/\r/g,"\n")).split("\n").map(e=>e.trim()).filter(e=>e.length>0).join("\n")).includes("BEGIN PRIVATE KEY")&&!t.includes("BEGIN RSA PRIVATE KEY"))throw Error("Firebase Admin SDK private key 格式不正確：缺少 BEGIN PRIVATE KEY 或 BEGIN RSA PRIVATE KEY");let r=t.includes("BEGIN PRIVATE KEY")||t.includes("BEGIN RSA PRIVATE KEY"),n=t.includes("END PRIVATE KEY")||t.includes("END RSA PRIVATE KEY");if(!r||!n)throw Error("Firebase Admin SDK private key 格式不正確：缺少 BEGIN 或 END 標記");let u=t.match(/(BEGIN (?:RSA )?PRIVATE KEY)/),l=t.match(/(END (?:RSA )?PRIVATE KEY)/);if(!u||!l)throw Error("Firebase Admin SDK private key 格式不正確：無法找到 BEGIN 或 END 標記");let d=u.index+u[0].length,p=l.index;if(p<=d)throw Error("Firebase Admin SDK private key 格式不正確：BEGIN 和 END 之間沒有內容");let I=t.substring(d,p).trim();if(0===I.length)throw Error("Firebase Admin SDK private key 格式不正確：私鑰內容為空");if(!process.env.FIREBASE_ADMIN_PROJECT_ID||!process.env.FIREBASE_ADMIN_CLIENT_EMAIL)throw Error("Firebase Admin SDK 配置不完整：缺少 PROJECT_ID 或 CLIENT_EMAIL");let h={projectId:process.env.FIREBASE_ADMIN_PROJECT_ID,clientEmail:process.env.FIREBASE_ADMIN_CLIENT_EMAIL,privateKey:t};return E=(0,i.initializeApp)({credential:(0,i.cert)(h),projectId:process.env.FIREBASE_ADMIN_PROJECT_ID}),A=(0,a.getAuth)(E),m=(0,s.getFirestore)(E),{adminApp:E,adminAuth:A,adminDb:m}}function d(){return l().adminAuth}function p(){return l().adminDb}n()}catch(e){n(e)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,972],()=>r(19655));module.exports=n})();